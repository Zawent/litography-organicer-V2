<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Renombrar Archivos</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <h1>Litography Organicer</h1>

    <div class="checkboxes">

        <div class="left-checks">
            <div class="organizador">
                <label><input type="checkbox" id="checkboxApellidoPrimero" onchange="toggleCheckboxes(this)" checked>
                    Apellidos
                    primero</label>
                <label><input type="checkbox" id="checkboxNombrePrimero" onchange="toggleCheckboxes(this)"> Nombres
                    primero</label>
            </div>
            <div class="fondoIzquierda">
                <button onclick="ordenarNombre()">Ordenar Tabla</button>
                <button onclick="limpiarTabla()">Limpiar Tabla</button>
            </div>
        </div>
        <div class="container-checks">
            <h4>Agregar a la tabla</h4>
            <div>
                <label><input type="checkbox" id="toggleRH" onchange="toggleColumn('RH')"> RH</label>
                <label><input type="checkbox" id="toggleDOCUMENTO" onchange="toggleColumn('DOCUMENTO')">
                    DOCUMENTO</label>
                <label><input type="checkbox" id="toggleCODIGO" onchange="toggleColumn('CODIGO')"> CÓDIGO</label>
            </div>
        </div>
    </div>

    <!-- Tabla de datos -->
    <div class="tabla-scroll">
        <table id="tabla">
            <thead>
                <tr>
                    <th>NOMBRE</th>
                    <th>APELLIDO</th>
                    <th>ORDEN DE FOTO</th>
                    <th class="col-RH" style="display:none;">RH</th>
                    <th class="col-DOCUMENTO" style="display:none;">DOCUMENTO</th>
                    <th class="col-CODIGO" style="display:none;">CÓDIGO</th>
                </tr>
            </thead>
            <tbody>
                <!-- Fila de inputs vacíos -->
                <tr>
                    <td><input type="text"></td>
                    <td><input type="text"></td>
                    <td><input type="text"></td>
                    <td class="col-RH" style="display:none;"><input type="text"></td>
                    <td class="col-DOCUMENTO" style="display:none;"><input type="text"></td>
                    <td class="col-CODIGO" style="display:none;"><input type="text"></td>
                </tr>
                <!-- Puedes duplicar más filas si necesitas más inputs -->
            </tbody>
        </table>
    </div>

    <br>

    <section class="botonesBottom">
        <div style="margin: 10px 0;">
            <button onclick="agregarFila()">Agregar fila</button>
            <button onclick="eliminarFila()">Eliminar fila</button>
        </div>

        <button id="renombrarBtn" style="display:none;">Cambiar nombres</button>
        <button onclick="abrirModalExportacion()">Exportar a Excel</button>
    </section>

    <!-- Modal para exportación -->
    <div id="modalExportacion" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="cerrarModalExportacion()">&times;</span>

            <h2>Vista previa para exportar</h2>

            <div id="cajaConfig">
                <div>
                    <h2>Editar NOMBRE</h2>
                    <label><input type="checkbox" id="separarNombres"> Separar nombres</label><br>
                    <label><input type="checkbox" id="nombreMayuscula" onchange="controlarFormatoNombre('mayus')">
                        Nombres
                        en
                        MAYÚSCULA</label><br>
                    <label><input type="checkbox" id="nombreOracion" onchange="controlarFormatoNombre('oracion')">
                        Nombres
                        Tipo
                        Oración</label><br>
                </div>

                <div>
                    <h2>Editar APELLIDO</h2>
                    <label><input type="checkbox" id="separarApellidos"> Separar apellidos</label><br>
                    <label><input type="checkbox" id="apellidoMayuscula" onchange="controlarFormatoApellido('mayus')">
                        Apellidos en
                        MAYÚSCULA</label><br>
                    <label><input type="checkbox" id="apellidoOracion" onchange="controlarFormatoApellido('oracion')">
                        Apellidos Tipo
                        Oración</label><br>
                </div>
            </div>
            <div id="tablaExportacion"></div>
            <button onclick="generarExcel()">Generar Excel</button>
        </div>
    </div>

    <!-- Modal de estado centrado -->
    <div id="overlayMensaje" style="display: none;">
        <div id="mensajeEstado">
            <span id="mensajeTexto"></span>
        </div>
    </div>



    <!-- Modal de notificación -->
    <div id="errorModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <p id="errorMessage"></p>
        </div>
    </div>


    <!-- Funcionalidad para que carguen automaticamente al iniciar 4 filas -->
    <script>
        function crearFilaVacia() {
            const tabla = document.getElementById("tabla").getElementsByTagName('tbody')[0];
            const filaOriginal = tabla.rows[0];
            const nuevaFila = filaOriginal.cloneNode(true);

            // Limpiar inputs
            Array.from(nuevaFila.cells).forEach(celda => {
                const input = celda.querySelector('input');
                if (input) {
                    if (input.type === 'checkbox') {
                        input.checked = false;
                    } else {
                        input.value = '';
                    }
                }
            });

            tabla.appendChild(nuevaFila);
        }

        // Crear mínimo 4 filas al cargar
        window.addEventListener("DOMContentLoaded", () => {
            const tabla = document.getElementById("tabla").getElementsByTagName('tbody')[0];
            while (tabla.rows.length < 4) {
                crearFilaVacia();
            }
        });
    </script>

    <!-- Funcionalidad para botones AGREGAR Y BORRAR FILA -->
    <script>
        function agregarFila() {
            crearFilaVacia(); // Usa la función de antes
        }

        function eliminarFila() {
            const tabla = document.getElementById("tabla").getElementsByTagName('tbody')[0];
            if (tabla.rows.length > 4) {
                tabla.deleteRow(tabla.rows.length - 1);
            } else {
                alert("Debe haber al menos 4 filas en la tabla.");
            }
        }
    </script>

    <!-- Funcionalidad para columnas de RH, DOCUMENTO y CODIGO -->
    <script>
        function toggleColumn(colName) {
            const isChecked = document.getElementById(`toggle${colName}`).checked;
            const cells = document.querySelectorAll(`.col-${colName}`);

            cells.forEach(cell => {
                // Mostrar u ocultar la columna
                cell.style.display = isChecked ? '' : 'none';

                // Si se desmarca el checkbox, limpiamos el contenido de los inputs de esa columna
                if (!isChecked) {
                    const input = cell.querySelector('input');
                    if (input) {
                        if (input.type === 'checkbox') {
                            input.checked = false;
                        } else {
                            input.value = '';
                        }
                    }
                }
            });
        }
    </script>

    <!-- Este codigo de abajo es para el evento de pegado de la tabla -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tabla = document.getElementById('tabla');

            // Evento delegado: se aplica a cualquier input dentro de la tabla
            tabla.addEventListener('paste', function (event) {
                const input = event.target;
                if (input.tagName !== 'INPUT') return;

                event.preventDefault();

                const text = event.clipboardData.getData('text/plain');
                const lineas = text.split(/\r?\n/).filter(linea => linea.trim() !== '');

                // Obtener la celda (td) del input
                const td = input.closest('td');
                const tr = input.closest('tr');
                const filaIndex = Array.from(tabla.rows).indexOf(tr); // incluye thead, por eso inicia desde 1
                const celdaIndex = Array.from(tr.cells).indexOf(td);

                lineas.forEach((linea, i) => {
                    let filaObjetivo = tabla.rows[filaIndex + i]; // ya no sumamos 1 aquí

                    // Si no hay suficiente fila, crearla
                    if (!filaObjetivo) {
                        const nuevaFila = tabla.insertRow();
                        const columnas = tabla.rows[0].cells.length;

                        for (let j = 0; j < columnas; j++) {
                            const nuevaCelda = nuevaFila.insertCell();
                            const clase = tabla.rows[0].cells[j].className;
                            if (clase.includes('col-') && tabla.rows[0].cells[j].style.display === 'none') {
                                nuevaCelda.style.display = 'none';
                                nuevaCelda.className = clase;
                            } else {
                                nuevaCelda.className = clase;
                            }

                            // Crear el input con los estilos aplicados
                            const nuevoInput = document.createElement('input');
                            nuevoInput.type = 'text';  // Asegurarse de que el tipo sea 'text'
                            nuevoInput.classList.add('input-style'); // Agregar una clase para aplicar los estilos de CSS
                            nuevaCelda.appendChild(nuevoInput);
                        }
                        filaObjetivo = nuevaFila;
                    }

                    const celdaObjetivo = filaObjetivo.cells[celdaIndex];
                    if (celdaObjetivo) {
                        const inputObjetivo = celdaObjetivo.querySelector('input');
                        if (inputObjetivo) {
                            inputObjetivo.value = linea;
                        }
                    }
                });
            });
        });
    </script>

    <!-- Funcionalidad para evento de TAB -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            tabla.addEventListener('keydown', function (event) {
                if (event.key === 'Tab') {
                    const input = event.target;

                    if (input.tagName !== 'INPUT') return;

                    event.preventDefault();

                    const td = input.closest('td');
                    const tr = input.closest('tr');
                    const filaIndex = Array.from(tabla.rows).indexOf(tr);
                    const celdaIndex = Array.from(tr.cells).indexOf(td);

                    let siguienteFilaIndex = filaIndex + 1;
                    if (siguienteFilaIndex >= tabla.rows.length) {
                        // Si llegamos al final de las filas, ir a la siguiente columna
                        siguienteFilaIndex = 1; // Esto se asume, si tienes más filas, incrementa este índice
                    }

                    const siguienteFila = tabla.rows[siguienteFilaIndex];
                    const siguienteCelda = siguienteFila.cells[celdaIndex];
                    const siguienteInput = siguienteCelda.querySelector('input');

                    if (siguienteInput) {
                        siguienteInput.focus();
                    }
                }
            });
        })
    </script>

    <!-- Funcionalidad para Modal de Errores -->
    <script>
        // Función para mostrar el modal de notificación
        function showModal(message) {
            const modal = document.getElementById("errorModal");
            const errorMessage = document.getElementById("errorMessage");
            errorMessage.innerText = message;
            modal.style.display = "block";
        }

        // Función para cerrar el modal de notificación
        function closeModal() {
            const modal = document.getElementById("errorModal");
            modal.style.display = "none";
        }
    </script>

    <!-- Funcion de ordenar nombre y logica de Checkboxes -->
    <script>
        function toggleCheckboxes(clicked) {
            const apellidoPrimero = document.getElementById("checkboxApellidoPrimero");
            const nombrePrimero = document.getElementById("checkboxNombrePrimero");

            if (clicked.id === "checkboxApellidoPrimero") {
                nombrePrimero.checked = false;
            } else if (clicked.id === "checkboxNombrePrimero") {
                apellidoPrimero.checked = false;
            }
        }


        function ordenarNombre() {
            const tabla = document.getElementById('tabla');
            const filas = Array.from(tabla.tBodies[0].rows);

            const apellidoPrimero = document.getElementById("checkboxApellidoPrimero").checked;
            const nombrePrimero = document.getElementById("checkboxNombrePrimero").checked;

            const filasConNumero = [];
            const filasSinNumero = [];

            filas.forEach(fila => {
                const ordenInput = fila.cells[2].querySelector('input');
                const valor = ordenInput.value.trim();
                const numero = parseInt(valor, 10);

                if (!isNaN(numero)) {
                    filasConNumero.push({ fila, numero });
                } else {
                    filasSinNumero.push(fila);
                }
            });

            let seOrdenoPorNumero = false;
            if (filasConNumero.length > 1) {
                filasConNumero.sort((a, b) => a.numero - b.numero);
                seOrdenoPorNumero = true;
            }

            let algunaFilaOrdenada = false;
            [...filasConNumero.map(f => f.fila), ...filasSinNumero].forEach(fila => {
                const nombreInput = fila.cells[0].querySelector('input');
                const apellidoInput = fila.cells[1].querySelector('input');
                const nombreCompleto = nombreInput.value.trim();

                if (apellidoInput.value.trim() !== "") return;

                if (nombreCompleto) {
                    const palabras = nombreCompleto.split(/\s+/);

                    if (apellidoPrimero && palabras.length > 2) {
                        const apellidos = palabras.slice(0, 2).join(' ');
                        const nombreRestante = palabras.slice(2).join(' ');
                        apellidoInput.value = apellidos;
                        nombreInput.value = nombreRestante;
                        algunaFilaOrdenada = true;
                    } else if (nombrePrimero && palabras.length > 2) {
                        const apellidos = palabras.slice(-2).join(' ');
                        const nombreRestante = palabras.slice(0, -2).join(' ');
                        apellidoInput.value = apellidos;
                        nombreInput.value = nombreRestante;
                        algunaFilaOrdenada = true;
                    }
                }
            });

            const tbody = tabla.tBodies[0];
            [...filasConNumero.map(f => f.fila), ...filasSinNumero].forEach(fila => tbody.appendChild(fila));

            if (!algunaFilaOrdenada && !seOrdenoPorNumero) {
                showModal("No se pudo ordenar ninguna fila. Asegúrate de que haya más de 2 palabras en el nombre y que la columna 'Apellido' esté vacía.");
            }
        }

    </script>

    <!-- Funcion para evitar cosas diferente a numeros en ORDEN DE FOTO -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('#tabla tbody tr').forEach(fila => {
                const ordenInput = fila.cells[2].querySelector('input');
                ordenInput.setAttribute('type', 'number');
                ordenInput.setAttribute('min', '0');
            });
        });
    </script>

    <!-- Funcion para limpiar tabla -->
    <script>
        function limpiarTabla() {
            const tbody = document.querySelector('#tabla tbody');
            const filas = Array.from(tbody.rows);

            filas.forEach((fila, index) => {
                const inputs = fila.querySelectorAll('input');

                // Limpiar inputs
                inputs.forEach(input => {
                    if (input.type === 'checkbox') {
                        input.checked = false;
                    } else {
                        input.value = '';
                    }
                });

                // Eliminar filas después de la 4ta
                if (index >= 4) {
                    tbody.removeChild(fila);
                }
            });
        }
    </script>

    <!-- Modal para EXPORTAR A EXCEL -->
    <script>
        // Abrir modal y generar tabla de inmediato
        function abrirModalExportacion() {
            document.getElementById('modalExportacion').style.display = 'block';
            actualizarVistaPrevia();
        }

        // Cerrar modal
        function cerrarModalExportacion() {
            document.getElementById('modalExportacion').style.display = 'none';
        }

        // Control exclusivo entre "MAYUSCULA" y "Tipo Oración"
        function controlarFormatoNombre(formato) {
            const mayus = document.getElementById('nombreMayuscula');
            const oracion = document.getElementById('nombreOracion');

            if (formato === 'mayus') oracion.checked = false;
            else if (formato === 'oracion') mayus.checked = false;

            actualizarVistaPrevia();
        }

        function controlarFormatoApellido(formato) {
            const mayus = document.getElementById('apellidoMayuscula');
            const oracion = document.getElementById('apellidoOracion');

            if (formato === 'mayus') oracion.checked = false;
            else if (formato === 'oracion') mayus.checked = false;

            actualizarVistaPrevia();
        }

        // Eventos para opciones de apellido
        document.getElementById('separarApellidos').addEventListener('change', actualizarVistaPrevia);
        document.getElementById('apellidoMayuscula').addEventListener('change', () => controlarFormatoApellido('mayus'));
        document.getElementById('apellidoOracion').addEventListener('change', () => controlarFormatoApellido('oracion'));

        // Eventos para opciones de nombre
        document.getElementById('separarNombres').addEventListener('change', actualizarVistaPrevia);
        document.getElementById('nombreMayuscula').addEventListener('change', () => controlarFormatoNombre('mayus'));
        document.getElementById('nombreOracion').addEventListener('change', () => controlarFormatoNombre('oracion'));

        // Actualiza la vista previa
        function actualizarVistaPrevia() {
            const tablaHTML = generarTablaExportacion();
            const contenedor = document.getElementById('tablaExportacion');
            contenedor.innerHTML = '';
            contenedor.appendChild(tablaHTML);
        }

        function generarTablaExportacion() {
            const tablaOriginal = document.getElementById('tabla');
            const tablaExport = document.createElement('table');
            tablaExport.classList.add('excel-preview');

            const thead = tablaExport.createTHead();
            const tbody = tablaExport.createTBody();

            const separarNombres = document.getElementById('separarNombres').checked;
            const nombreMayus = document.getElementById('nombreMayuscula').checked;
            const nombreOracion = document.getElementById('nombreOracion').checked;
            const separarApellidos = document.getElementById('separarApellidos').checked;
            const apellidoMayus = document.getElementById('apellidoMayuscula').checked;
            const apellidoOracion = document.getElementById('apellidoOracion').checked;

            const filasOriginales = tablaOriginal.tBodies[0].rows;
            if (filasOriginales.length === 0) return tablaExport;

            const cabecera = thead.insertRow();
            const campos = [];
            const totalColumnas = tablaOriginal.tHead.rows[0].cells.length;

            // Detectar columnas visibles
            const columnasVisibles = Array.from({ length: totalColumnas }, (_, i) => {
                return Array.from(filasOriginales).some(row => {
                    const input = row.cells[i].querySelector('input');
                    return input && input.value.trim() !== '';
                });
            });

            for (let i = 0; i < totalColumnas; i++) {
                if (!columnasVisibles[i]) continue;

                const label = tablaOriginal.tHead.rows[0].cells[i].textContent.trim().toUpperCase();

                if (label === 'NOMBRE') {
                    let maxPartes = 1;
                    Array.from(filasOriginales).forEach(row => {
                        const valor = row.cells[i].querySelector('input')?.value.trim() || '';
                        const partes = valor.split(/\s+/);
                        if (partes.length > maxPartes) maxPartes = partes.length;
                    });

                    if (separarNombres) {
                        for (let idx = 0; idx < maxPartes; idx++) {
                            cabecera.insertCell().textContent = `NOMBRE${idx + 1}`;
                        }
                        campos.push({ tipo: 'nombre_separado', index: i, partes: maxPartes });
                    } else {
                        cabecera.insertCell().textContent = 'NOMBRE';
                        campos.push({ tipo: 'nombre_unico', index: i });
                    }
                } else if (label === 'APELLIDO') {
                    let maxPartes = 1;
                    Array.from(filasOriginales).forEach(row => {
                        const valor = row.cells[i].querySelector('input')?.value.trim() || '';
                        const partes = valor.split(/\s+/);
                        if (partes.length > maxPartes) maxPartes = partes.length;
                    });

                    if (separarApellidos) {
                        for (let idx = 0; idx < maxPartes; idx++) {
                            cabecera.insertCell().textContent = `APELLIDO${idx + 1}`;
                        }
                        campos.push({ tipo: 'apellido_separado', index: i, partes: maxPartes });
                    } else {
                        cabecera.insertCell().textContent = 'APELLIDO';
                        campos.push({ tipo: 'apellido_unico', index: i });
                    }
                } else {
                    cabecera.insertCell().textContent = label;
                    campos.push({ tipo: 'normal', index: i });
                }
            }

            // Crear filas
            Array.from(filasOriginales).forEach(row => {
                const esFilaVacia = campos.every(campo => {
                    const input = row.cells[campo.index].querySelector('input');
                    return !input || input.value.trim() === '';
                });

                if (esFilaVacia) return;

                const nuevaFila = tbody.insertRow();

                campos.forEach(campo => {
                    const input = row.cells[campo.index].querySelector('input');
                    let valor = input?.value.trim() || '';

                    const aplicarFormato = (texto, mayus, oracion) => {
                        if (mayus) return texto.toUpperCase();
                        if (oracion) {
                            return texto
                                .toLowerCase()
                                .split(' ')
                                .map(palabra => palabra.charAt(0).toUpperCase() + palabra.slice(1))
                                .join(' ');
                        }
                        return texto;
                    };


                    if (campo.tipo === 'nombre_unico') {
                        nuevaFila.insertCell().textContent = aplicarFormato(valor, nombreMayus, nombreOracion);
                    } else if (campo.tipo === 'apellido_unico') {
                        nuevaFila.insertCell().textContent = aplicarFormato(valor, apellidoMayus, apellidoOracion);
                    } else if (campo.tipo === 'nombre_separado') {
                        valor = aplicarFormato(valor, nombreMayus, nombreOracion);
                        const partes = valor.split(/\s+/);
                        for (let i = 0; i < campo.partes; i++) {
                            nuevaFila.insertCell().textContent = partes[i] || '';
                        }
                    } else if (campo.tipo === 'apellido_separado') {
                        valor = aplicarFormato(valor, apellidoMayus, apellidoOracion);
                        const partes = valor.split(/\s+/);
                        for (let i = 0; i < campo.partes; i++) {
                            nuevaFila.insertCell().textContent = partes[i] || '';
                        }
                    } else if (campo.tipo === 'normal') {
                        nuevaFila.insertCell().textContent = valor;
                    }
                });
            });

            return tablaExport;
        }
    </script>

    <!-- EXportar a excel -->
    <script>
        let rutaExcel = ""; // Para almacenar la ruta del archivo Excel exportado

        function mostrarMensajeEstado(texto, color = "#4caf50") {
            const overlay = document.getElementById("overlayMensaje");
            const mensaje = document.getElementById("mensajeEstado");
            const mensajeTexto = document.getElementById("mensajeTexto");

            mensajeTexto.textContent = texto;
            mensaje.style.backgroundColor = color;
            overlay.style.display = "flex";

            setTimeout(() => {
                overlay.style.display = "none";
            }, 3000);
        }


        function generarExcel() {
            const tabla = document.querySelector("#tablaExportacion table");
            const datos = [];

            if (!tabla) {
                mostrarMensajeEstado("No se encontró ninguna tabla para exportar.", "#f44336"); // rojo
                return;
            }

            const headers = Array.from(tabla.rows[0].cells).map(cell => cell.innerText.trim());

            for (let i = 1; i < tabla.rows.length; i++) {
                const row = tabla.rows[i];
                const fila = {};
                for (let j = 0; j < row.cells.length; j++) {
                    fila[headers[j]] = row.cells[j].innerText.trim();
                }
                datos.push(fila);
            }

            window.pywebview.api.exportar_excel(datos).then(mensaje => {
                mostrarMensajeEstado("Exportación exitosa.");
                cerrarModalExportacion(); // Cierra el modal automáticamente
                rutaExcel = mensaje.split("\n")[1].trim();
                document.getElementById("renombrarBtn").style.display = "inline-block";
            }).catch(error => {
                mostrarMensajeEstado("Error al exportar: " + error, "#f44336");
            });
        }

        // Ejecutar renombrado
        document.getElementById("renombrarBtn").addEventListener("click", function () {
            if (!rutaExcel) {
                mostrarMensajeEstado("No se ha exportado un archivo Excel aún.", "#f44336");
                return;
            }

            window.pywebview.api.ejecutar_renombrado(rutaExcel).then(function (response) {
                mostrarMensajeEstado(response);
            }).catch(error => {
                mostrarMensajeEstado("Error al ejecutar renombrado: " + error, "#f44336");
            });
        });

        // Llamada para generar el Excel
        document.getElementById("exportarBtn").addEventListener("click", generarExcel);
    </script>




</body>

</html>